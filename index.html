<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Minesweeper</title>
  <style>
    /* html, body ã‚’ä¸­å¤®ã«é…ç½®ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;    /* æ¨ªæ–¹å‘ä¸­å¤®æƒãˆ */
      justify-content: center; /* ç¸¦æ–¹å‘ä¸­å¤®æƒãˆ */
      font-family: sans-serif;
    }
    
    /* ã‚²ãƒ¼ãƒ ç›¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãªã©ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    table {
      border-collapse: collapse;
      margin-top: 10px;
    }
    td {
      width: 30px;
      height: 30px;
      border: 1px solid #999;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
      user-select: none;
      font-size: 16px;
    }
    td.revealed { background-color: #ddd; }
    td.bomb { background-color: red; }
    td.flagged { background-color: yellow; }
    
    /* ãã®ä»–ã® UI éƒ¨å“ */
    #difficulty-selection { margin-bottom: 20px; }
    #message { font-size: 18px; margin-top: 10px; color: blue; }
  </style>
</head>
<body>
  <!-- é›£æ˜“åº¦é¸æŠç”¨UI -->
  <div id="difficulty-selection">
    <h2>é›£æ˜“åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
    <button data-difficulty="easy">ç°¡å˜</button>
    <button data-difficulty="normal">æ™®é€š</button>
    <button data-difficulty="hard">é›£ã—ã„</button>
  </div>

  <!-- ã‚²ãƒ¼ãƒ ç›¤ã‚’è¡¨ç¤ºã™ã‚‹é ˜åŸŸ -->
  <div id="game-container" style="display: none;">
    <div id="game"></div>
  </div>

  <!-- ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
  <div id="message"></div>

  <script type="module">
    /******************************************************************
     * Ruby WASM ã®èª­ã¿è¾¼ã¿
     ******************************************************************/
    import { DefaultRubyVM } from "https://cdn.jsdelivr.net/npm/@ruby/wasm-wasi@2.7.1/dist/browser/+esm";

    // Ruby+stdlib.wasm ã®å–å¾—ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
    const response = await fetch("https://cdn.jsdelivr.net/npm/@ruby/3.4-wasm-wasi@2.7.1/dist/ruby+stdlib.wasm");
    const module = await WebAssembly.compileStreaming(response);
    const { vm } = await DefaultRubyVM(module);

    /******************************************************************
     * Ruby ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ï¼ˆå„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ HTTP çµŒç”±ã§å–å¾—ã—ã¦ vm.eval ã§è©•ä¾¡ï¼‰
     ******************************************************************/
    async function loadRubyFile(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) {
          console.error(`Failed to load ${path}: ${res.status} ${res.statusText}`);
          return;
        }
        const source = await res.text();
        console.log(`Loaded ${path}`);
        vm.eval(source);
      } catch (e) {
        console.error(`Error loading ${path}:`, e);
      }
    }

    // èª­ã¿è¾¼ã‚€ Ruby ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤
    const rubyFiles = [
      "domains/validators/base.rb",
      "domains/validators/cell_validator.rb",
      "domains/validators/grid_cells_validator.rb",
      "domains/validators/position_validator.rb",
      "domains/base.rb",
      "domains/cell_with_neighbors.rb",
      "domains/cell.rb",
      "domains/grid_cells_factory.rb",
      "domains/grid_cells.rb",
      "domains/position.rb",
      "domains/minesweeper.rb"
    ];

    for (const path of rubyFiles) {
      console.log(`Loading ${path}...`);
      await loadRubyFile(path);
    }

    // â˜… JSON ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ï¼ˆRuby å´ã§ JSON ã‚’åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
    vm.eval("require 'json'");

    /******************************************************************
     * UI ãŠã‚ˆã³ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
     ******************************************************************/
    const difficultySelectionDiv = document.getElementById("difficulty-selection");
    const gameContainer = document.getElementById("game-container");
    const gameDiv = document.getElementById("game");
    const messageDiv = document.getElementById("message");

    // é›£æ˜“åº¦é¸æŠå¾Œã€Ruby å´ã§ Minesweeper ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã—ã€ç›¤é¢ã‚’æ§‹ç¯‰ã™ã‚‹
    function startGame(difficulty) {
      // Ruby å´ã§ Minesweeper ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
      vm.eval(`$game = Domains::Minesweeper.new(:${difficulty})`);

      // é›£æ˜“åº¦é¸æŠUIã‚’éè¡¨ç¤ºã€ã‚²ãƒ¼ãƒ ç›¤ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
      difficultySelectionDiv.style.display = "none";
      gameContainer.style.display = "block";

      // Ruby å´ã‹ã‚‰ç›¤é¢ã®ã‚µã‚¤ã‚ºã‚’å–å¾—ï¼ˆæ•´æ•°ã«å¤‰æ›ï¼‰
      const gridWidth = parseInt(vm.eval("($game.grid_cells.width).to_i"));
      const gridHeight = parseInt(vm.eval("($game.grid_cells.height).to_i"));
      console.log("Grid size:", gridWidth, gridHeight);

      // ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ã‚’ç”Ÿæˆã—ã¦å„ã‚»ãƒ«ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
      const table = document.createElement("table");
      table.id = "game-table";
      for (let y = 0; y < gridHeight; y++) {
        const tr = document.createElement("tr");
        for (let x = 0; x < gridWidth; x++) {
          const td = document.createElement("td");
          td.dataset.x = x;
          td.dataset.y = y;
          td.addEventListener("click", () => {
            revealCell(x, y);
          });
          td.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            toggleFlag(x, y);
          });
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }
      gameDiv.innerHTML = "";
      gameDiv.appendChild(table);

      // åˆæœŸçŠ¶æ…‹ã®ç›¤é¢ã‚’æ›´æ–°
      updateGridUI();
    }

    // Ruby å´ã®ç›¤é¢çŠ¶æ…‹ã‚’ JSON åŒ–ã—ã¦å–å¾—ã—ã€UI ã®å„ã‚»ãƒ«ã«åæ˜ ã™ã‚‹
    function updateGridUI() {
      // Ruby å´ã§ $game.grid_cells.to_a ãŒå„ã‚»ãƒ«ã®çŠ¶æ…‹ï¼ˆx, y, revealed, flagged, bomb, number ç­‰ï¼‰ã‚’è¿”ã™å‰æ
      const jsonStr = vm.eval('JSON.generate($game.grid_cells.to_a)');
      const gridState = JSON.parse(jsonStr);

      gridState.forEach(cell => {
        // ã‚»ãƒ«ã®åº§æ¨™ã«å¯¾å¿œã™ã‚‹ <td> è¦ç´ ã‚’å–å¾—
        const td = document.querySelector(`td[data-x="${cell.x}"][data-y="${cell.y}"]`);
        if (!td) return;

        // é–‹å°çŠ¶æ…‹ã®å ´åˆã®è¡¨ç¤º
        if (cell.revealed) {
          td.classList.add("revealed");
          if (cell.bomb) {
            td.classList.add("bomb");
            td.textContent = "ğŸ’£";
          } else {
            td.textContent = cell.neighbor_bomb_cell_count > 0 ? cell.neighbor_bomb_cell_count : "";
          }
          // é–‹å°æ¸ˆã¿ãªã‚‰ãƒ•ãƒ©ã‚°çŠ¶æ…‹ã®ã‚¯ãƒ©ã‚¹ã¯é™¤å»
          td.classList.remove("flagged");
        }
        // æœªé–‹å°ã®å ´åˆã®å‡¦ç†
        else {
          if (cell.flagged) {
            td.classList.add("flagged");
            td.textContent = "ğŸš©";
          } else {
            td.classList.remove("flagged");
            td.textContent = "";
          }
        }
      });
    }

    // ã‚»ãƒ«ã‚’é–‹å°ã™ã‚‹ï¼ˆCLIç‰ˆã® reveal ã‚³ãƒãƒ³ãƒ‰ã«ç›¸å½“ï¼‰
    function revealCell(x, y) {
      vm.eval(`$game.reveal_cell(${x}, ${y})`);
      updateGridUI();
      checkGameStatus();
    }

    // ã‚»ãƒ«ã®ãƒ•ãƒ©ã‚°ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹ï¼ˆCLIç‰ˆã® flag ã‚³ãƒãƒ³ãƒ‰ã«ç›¸å½“ï¼‰
    function toggleFlag(x, y) {
      vm.eval(`$game.toggle_flag(${x}, ${y})`);
      updateGridUI();
    }

    // ã‚²ãƒ¼ãƒ çµ‚äº†çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
    function checkGameStatus() {
      const finished = vm.eval("$game.finished?").toString() === "true";
      if (finished) {
        updateGridUI();
        if (vm.eval("$game.grid_cells.bombed?").toString() === "true") {
          messageDiv.textContent = "çˆ†å¼¾ã‚’é–‹ã„ã¦ã—ã¾ã„ã¾ã—ãŸâ€¦";
        } else {
          messageDiv.textContent = "ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼å…¨ã¦ã®ã‚»ãƒ«ã‚’é–‹å°ã—ã¾ã—ãŸï¼";
        }
      }
    }

    // é›£æ˜“åº¦é¸æŠãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    document.querySelectorAll("#difficulty-selection button").forEach(button => {
      button.addEventListener("click", (e) => {
        const difficulty = e.target.dataset.difficulty;
        startGame(difficulty);
      });
    });
  </script>
</body>
</html>
